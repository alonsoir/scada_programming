# ğŸš€ AEROSPACE SCADA & SECURITY SYSTEMS - Unified Makefile
# Comandos para gestiÃ³n fÃ¡cil del sistema SCADA y detector de protocolos inusuales

.PHONY: help install start start-dev start-simple stop clean test status scapy-help

# Variables
PYTHON := python3
VENV := scada_env
PIP := $(VENV)/bin/pip
PYTHON_VENV := $(VENV)/bin/python
CURRENT_DIR := $(shell basename $(CURDIR))

# Detectar si estamos en directorio scapy
ifeq ($(CURRENT_DIR),scapy)
    PROJECT_MODE := scapy
    PROJECT_NAME := Security Protocol Detector
else
    PROJECT_MODE := scada
    PROJECT_NAME := Aerospace SCADA System
endif

# Comando por defecto
help: ## ğŸ“š Mostrar ayuda
	@echo "ğŸš€ $(PROJECT_NAME)"
	@echo "=========================="
	@echo ""
ifeq ($(PROJECT_MODE),scapy)
	@echo "ğŸ›¡ï¸  DETECTOR DE PROTOCOLOS INUSUALES"
	@echo "   Herramientas de seguridad de red para detecciÃ³n de amenazas"
	@echo ""
	@echo "Comandos de Seguridad:"
	@echo ""
	@grep -E '^[a-zA-Z_-]+:.*?## ğŸ›¡ï¸.*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "  \033[31m%-20s\033[0m %s\n", $$1, $$2}'
	@echo ""
	@echo "Comandos de Testing:"
	@echo ""
	@grep -E '^[a-zA-Z_-]+:.*?## ğŸ§ª.*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "  \033[33m%-20s\033[0m %s\n", $$1, $$2}'
	@echo ""
	@echo "ğŸ¯ Inicio rÃ¡pido (Seguridad):"
	@echo "  make setup-security     # Configurar entorno de seguridad"
	@echo "  make detector-start     # Iniciar detector"
	@echo "  make test-sctp          # Validar detecciÃ³n SCTP"
	@echo ""
	@echo "âš ï¸  IMPORTANTE: Los comandos de testing generan trÃ¡fico de red"
	@echo "   Solo usar en entornos controlados"
else
	@echo "ğŸš€ SISTEMA SCADA AEROESPACIAL"
	@echo "   Sistema de supervisiÃ³n y control industrial"
	@echo ""
	@echo "Comandos SCADA:"
	@echo ""
	@grep -E '^[a-zA-Z_-]+:.*?## ğŸš€.*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "  \033[36m%-20s\033[0m %s\n", $$1, $$2}'
	@echo ""
	@echo "ğŸ¯ Inicio rÃ¡pido (SCADA):"
	@echo "  make install            # Configurar entorno"
	@echo "  make start              # Lanzar sistema completo"
	@echo ""
	@echo "ğŸ›¡ï¸  Para herramientas de seguridad:"
	@echo "  cd scapy && make help   # Cambiar a modo seguridad"
endif
	@echo ""
	@echo "Comandos Generales:"
	@echo ""
	@grep -E '^[a-zA-Z_-]+:.*?## ğŸ”§.*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "  \033[32m%-20s\033[0m %s\n", $$1, $$2}'
	@echo ""

# ============================================
# COMANDOS SCADA (Modo por defecto en raÃ­z)
# ============================================

install: ## ğŸš€ Instalar entorno SCADA y dependencias
ifeq ($(PROJECT_MODE),scada)
	@echo "ğŸ› ï¸ Configurando entorno SCADA..."
	$(PYTHON) -m venv $(VENV)
	$(PIP) install --upgrade pip
	$(PIP) install -r requirements.txt
	@echo "âœ… Entorno SCADA configurado correctamente"
	@echo "ğŸ’¡ Usa 'make start' para lanzar el sistema"
else
	@echo "âš ï¸  EstÃ¡s en modo Security. Usa 'make setup-security' en su lugar"
endif

start: ## ğŸš€ Lanzar sistema SCADA completo (recomendado)
ifeq ($(PROJECT_MODE),scada)
	@echo "ğŸš€ Lanzando Sistema SCADA completo..."
	$(PYTHON_VENV) launch_scada.py
else
	@echo "âš ï¸  Comando SCADA. Usa 'make detector-start' para seguridad"
endif

start-dev: ## ğŸš€ Lanzar SCADA en modo desarrollo
ifeq ($(PROJECT_MODE),scada)
	@echo "ğŸ”§ Lanzando en modo desarrollo..."
	$(PYTHON_VENV) dev_start.py
else
	@echo "âš ï¸  Comando SCADA. Usa 'make detector-dev' para seguridad"
endif

start-simple: ## ğŸš€ Lanzamiento SCADA simple (sin navegador automÃ¡tico)
ifeq ($(PROJECT_MODE),scada)
	@echo "âš¡ Lanzamiento simple..."
	$(PYTHON_VENV) launch_scada.py --no-browser
else
	@echo "âš ï¸  Comando SCADA no disponible en modo Security"
endif

start-debug: ## ğŸš€ Lanzar SCADA con logs detallados
ifeq ($(PROJECT_MODE),scada)
	@echo "ğŸ› Lanzando con debug..."
	$(PYTHON_VENV) launch_scada.py --debug
else
	@echo "âš ï¸  Comando SCADA no disponible en modo Security"
endif

plc-only: ## ğŸš€ Solo PLC Virtual
ifeq ($(PROJECT_MODE),scada)
	@echo "ğŸ”§ Iniciando solo PLC Virtual..."
	$(PYTHON_VENV) core/simulation/virtual_plc.py
else
	@echo "âš ï¸  Comando SCADA no disponible en modo Security"
endif

hmi-only: ## ğŸš€ Solo HMI Web
ifeq ($(PROJECT_MODE),scada)
	@echo "ğŸŒ Iniciando solo HMI Web..."
	$(PYTHON_VENV) run_hmi.py
else
	@echo "âš ï¸  Comando SCADA no disponible en modo Security"
endif

monitor: ## ğŸš€ Monitor de consola SCADA
ifeq ($(PROJECT_MODE),scada)
	@echo "ğŸ“Š Iniciando monitor..."
	$(PYTHON_VENV) test_connection.py
else
	@echo "âš ï¸  Comando SCADA no disponible en modo Security"
endif

# ============================================
# COMANDOS SECURITY (Modo scapy)
# ============================================

setup-security: ## ğŸ›¡ï¸ Configurar entorno de seguridad
ifeq ($(PROJECT_MODE),scapy)
	@echo "ğŸ›¡ï¸ Configurando entorno de seguridad..."
	@echo "ğŸ” Verificando permisos root..."
	@if [ "$$(id -u)" -ne 0 ]; then \
		echo "âš ï¸  Algunos comandos requieren sudo para captura de paquetes"; \
	fi
	$(PYTHON) -c "import scapy; print('âœ… Scapy disponible')" 2>/dev/null || pip install scapy
	@echo "âœ… Entorno de seguridad configurado"
	@echo "ğŸ’¡ Usa 'make detector-start' para iniciar detector"
else
	@echo "âš ï¸  Cambia al directorio scapy primero: cd scapy && make setup-security"
endif

detector-start: ## ğŸ›¡ï¸ Iniciar detector de protocolos inusuales
ifeq ($(PROJECT_MODE),scapy)
	@echo "ğŸ›¡ï¸ Iniciando detector de protocolos inusuales..."
	@echo "âš ï¸  Requiere permisos de root para captura de paquetes"
	sudo $(PYTHON) unusual_protocol_detector.py
else
	@echo "âš ï¸  Cambia al directorio scapy primero: cd scapy && make detector-start"
endif

detector-dev: ## ğŸ›¡ï¸ Detector en modo desarrollo (verbose)
ifeq ($(PROJECT_MODE),scapy)
	@echo "ğŸ”§ Detector en modo desarrollo..."
	sudo $(PYTHON) unusual_protocol_detector.py --verbose
else
	@echo "âš ï¸  Cambia al directorio scapy primero: cd scapy && make detector-dev"
endif

detector-test: ## ğŸ›¡ï¸ Verificar instalaciÃ³n del detector
ifeq ($(PROJECT_MODE),scapy)
	@echo "ğŸ§ª Verificando detector..."
	sudo /opt/unusual-protocol-detector/start_detector.sh --test 2>/dev/null || \
	$(PYTHON) -c "from scapy.layers.inet import IP; from scapy.layers.sctp import SCTP; print('âœ… Detector listo')"
else
	@echo "âš ï¸  Cambia al directorio scapy primero: cd scapy && make detector-test"
endif

test-sctp: ## ğŸ§ª Generar trÃ¡fico SCTP de prueba
ifeq ($(PROJECT_MODE),scapy)
	@echo "ğŸ§ª Generando trÃ¡fico SCTP de prueba..."
	@echo "âš ï¸  IMPORTANTE: Solo usar en entornos controlados"
	@echo "âš ï¸  Este comando genera trÃ¡fico de red sintÃ©tico"
	@read -p "Â¿Continuar? (y/N): " confirm && [ "$$confirm" = "y" ] || exit 1
	sudo $(PYTHON) sctp_test_generator.py
else
	@echo "âš ï¸  Cambia al directorio scapy primero: cd scapy && make test-sctp"
endif

test-simple: ## ğŸ§ª Test simple de detecciÃ³n SCTP
ifeq ($(PROJECT_MODE),scapy)
	@echo "ğŸ§ª Test simple de detecciÃ³n..."
	sudo $(PYTHON) test_simple_sctp.py
else
	@echo "âš ï¸  Cambia al directorio scapy primero: cd scapy && make test-simple"
endif

analyze-logs: ## ğŸ›¡ï¸ Analizar logs de seguridad
ifeq ($(PROJECT_MODE),scapy)
	@echo "ğŸ“Š Analizando logs de seguridad..."
	sudo /opt/unusual-protocol-detector/analyze_logs.sh 2>/dev/null || \
	$(PYTHON) log_analyzer.py --log /var/log/unusual-protocols/unusual_protocols.log 2>/dev/null || \
	echo "âš ï¸  No se encontraron logs. Ejecuta el detector primero"
else
	@echo "âš ï¸  Cambia al directorio scapy primero: cd scapy && make analyze-logs"
endif

setup-production: ## ğŸ›¡ï¸ Instalar detector en producciÃ³n
ifeq ($(PROJECT_MODE),scapy)
	@echo "ğŸ›¡ï¸ Instalando detector en producciÃ³n..."
	@echo "âš ï¸  Requiere permisos de administrador"
	sudo bash production_setup.sh
else
	@echo "âš ï¸  Cambia al directorio scapy primero: cd scapy && make setup-production"
endif

security-status: ## ğŸ›¡ï¸ Estado del sistema de seguridad
ifeq ($(PROJECT_MODE),scapy)
	@echo "ğŸ›¡ï¸ Estado del Sistema de Seguridad:"
	@echo "=================================="
	@echo "ğŸ” Detector de Protocolos:"
	@pgrep -f "unusual_protocol_detector.py" >/dev/null && echo "   âœ… EjecutÃ¡ndose" || echo "   âŒ Detenido"
	@echo "ğŸ“Š Logs:"
	@if [ -f "/var/log/unusual-protocols/unusual_protocols.log" ]; then \
		echo "   âœ… Logs disponibles"; \
		echo "   ğŸ“„ Ãšltimo evento: $$(tail -1 /var/log/unusual-protocols/unusual_protocols.log 2>/dev/null | cut -d' ' -f1-2)"; \
	else \
		echo "   âŒ Sin logs"; \
	fi
	@echo "ğŸ”§ Interfaz de red:"
	@echo "   Monitoreando: en0 (por defecto)"
else
	@echo "âš ï¸  Cambia al directorio scapy primero: cd scapy && make security-status"
endif

# ============================================
# COMANDOS GENERALES (Ambos modos)
# ============================================

test: ## ğŸ”§ Ejecutar tests apropiados
ifeq ($(PROJECT_MODE),scada)
	@echo "ğŸ§ª Ejecutando tests SCADA..."
	$(PYTHON_VENV) tests/minimal_test.py
	$(PYTHON_VENV) tests/simple_test.py
	@echo "âœ… Tests SCADA completados"
else
	@echo "ğŸ§ª Ejecutando tests de seguridad..."
	@make detector-test
	@echo "âœ… Tests de seguridad completados"
endif

stop: ## ğŸ”§ Detener todos los procesos
ifeq ($(PROJECT_MODE),scada)
	@echo "ğŸ›‘ Deteniendo procesos SCADA..."
	@pkill -f "virtual_plc.py" 2>/dev/null || true
	@pkill -f "run_hmi.py" 2>/dev/null || true
	@pkill -f "launch_scada.py" 2>/dev/null || true
	@echo "âœ… Procesos SCADA detenidos"
else
	@echo "ğŸ›‘ Deteniendo procesos de seguridad..."
	@sudo pkill -f "unusual_protocol_detector.py" 2>/dev/null || true
	@sudo launchctl unload /Library/LaunchDaemons/com.security.unusual-protocol-detector.plist 2>/dev/null || true
	@echo "âœ… Procesos de seguridad detenidos"
endif

status: ## ğŸ”§ Estado del sistema
ifeq ($(PROJECT_MODE),scada)
	@echo "ğŸ“Š Estado del Sistema SCADA:"
	@echo "=========================="
	@echo "ğŸ”§ PLC Virtual:"
	@pgrep -f "virtual_plc.py" >/dev/null && echo "   âœ… EjecutÃ¡ndose" || echo "   âŒ Detenido"
	@echo "ğŸŒ HMI Web:"
	@pgrep -f "run_hmi.py" >/dev/null && echo "   âœ… EjecutÃ¡ndose" || echo "   âŒ Detenido"
	@echo ""
	@echo "ğŸŒ URLs:"
	@echo "   HMI Web: http://127.0.0.1:8050"
	@echo "   PLC Modbus: 127.0.0.1:5020"
else
	@make security-status
endif

clean: ## ğŸ”§ Limpiar archivos temporales
	@echo "ğŸ§¹ Limpiando archivos temporales..."
	find . -type f -name "*.pyc" -delete
	find . -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
	rm -rf .pytest_cache 2>/dev/null || true
ifeq ($(PROJECT_MODE),scada)
	rm -f /tmp/scada_*.log 2>/dev/null || true
	rm -rf logs/*.log 2>/dev/null || true
else
	@echo "ğŸ§¹ Limpiando logs de seguridad (requiere sudo)..."
	@sudo rm -f /var/log/unusual-protocols/*.log 2>/dev/null || true
endif
	@echo "âœ… Limpieza completada"

clean-all: clean ## ğŸ”§ Limpiar todo incluyendo entorno virtual
ifeq ($(PROJECT_MODE),scada)
	@echo "ğŸ—‘ï¸ Eliminando entorno virtual..."
	rm -rf $(VENV)
endif
	@echo "âœ… Limpieza completa terminada"

upgrade: ## ğŸ”§ Actualizar dependencias
ifeq ($(PROJECT_MODE),scada)
	@echo "â¬†ï¸ Actualizando dependencias SCADA..."
	$(PIP) install --upgrade -r requirements.txt
	@echo "âœ… Dependencias SCADA actualizadas"
else
	@echo "â¬†ï¸ Actualizando dependencias de seguridad..."
	pip install --upgrade scapy
	@echo "âœ… Dependencias de seguridad actualizadas"
endif

info: ## ğŸ”§ InformaciÃ³n del sistema
	@echo "â„¹ï¸ InformaciÃ³n del Sistema:"
	@echo "=========================="
	@echo "ğŸ Python: $(shell $(PYTHON) --version)"
	@echo "ğŸ“ Directorio: $(shell pwd)"
	@echo "ğŸ—ï¸ Modo de proyecto: $(PROJECT_MODE)"
ifeq ($(PROJECT_MODE),scada)
	@echo "ğŸ—ï¸ Entorno virtual: $(VENV)"
	@echo "ğŸ“¦ Dependencias SCADA:"
	@$(PYTHON_VENV) -c "import pymodbus; print(f'   pymodbus: {pymodbus.__version__}')" 2>/dev/null || echo "   pymodbus: No instalado"
	@$(PYTHON_VENV) -c "import dash; print(f'   dash: {dash.__version__}')" 2>/dev/null || echo "   dash: No instalado"
	@$(PYTHON_VENV) -c "import plotly; print(f'   plotly: {plotly.__version__}')" 2>/dev/null || echo "   plotly: No instalado"
else
	@echo "ğŸ“¦ Dependencias de Seguridad:"
	@$(PYTHON) -c "import scapy; print(f'   scapy: {scapy.__version__}')" 2>/dev/null || echo "   scapy: No instalado"
	@echo "ğŸ”§ Sistema de detecciÃ³n:"
	@ls /opt/unusual-protocol-detector/ 2>/dev/null | head -3 | sed 's/^/   /' || echo "   Sin instalaciÃ³n de producciÃ³n"
endif
	@echo ""
	@echo "ğŸ¯ Comandos principales:"
ifeq ($(PROJECT_MODE),scada)
	@echo "   make start              # Sistema SCADA completo"
	@echo "   cd scapy && make help   # Herramientas de seguridad"
else
	@echo "   make detector-start     # Detector de seguridad"
	@echo "   cd .. && make help      # Sistema SCADA"
endif

# ============================================
# COMANDOS DE DESARROLLO Y HELPERS
# ============================================

switch-to-scada: ## ğŸ”§ Cambiar a modo SCADA
ifeq ($(PROJECT_MODE),scapy)
	@echo "ğŸ”„ Cambiando a modo SCADA..."
	@echo "cd .. && make help"
	@cd .. && make help
else
	@echo "âœ… Ya estÃ¡s en modo SCADA"
endif

switch-to-security: ## ğŸ”§ Cambiar a modo Seguridad
ifeq ($(PROJECT_MODE),scada)
	@echo "ğŸ”„ Cambiando a modo Seguridad..."
	@if [ -d "scapy" ]; then \
		echo "cd scapy && make help"; \
		cd scapy && make help; \
	else \
		echo "âŒ Directorio scapy no encontrado"; \
	fi
else
	@echo "âœ… Ya estÃ¡s en modo Seguridad"
endif

project-info: ## ğŸ”§ InformaciÃ³n completa del proyecto
	@echo "ğŸ“‹ INFORMACIÃ“N COMPLETA DEL PROYECTO"
	@echo "===================================="
	@echo ""
	@echo "ğŸš€ Aerospace SCADA System (Directorio raÃ­z):"
	@echo "   - Sistema de supervisiÃ³n y control industrial"
	@echo "   - Interfaz HMI web con Dash/Plotly"
	@echo "   - ComunicaciÃ³n Modbus TCP con PLC virtual"
	@echo "   - SimulaciÃ³n de sistemas aeroespaciales"
	@echo ""
	@echo "ğŸ›¡ï¸ Unusual Protocol Detector (Directorio scapy):"
	@echo "   - Detector de protocolos inusuales en tiempo real"
	@echo "   - DetecciÃ³n de amenazas SCTP, GRE, ESP, OSPF"
	@echo "   - ClasificaciÃ³n inteligente de trÃ¡fico"
	@echo "   - Despliegue distribuido con ZeroMQ (roadmap)"
	@echo ""
	@echo "ğŸ¯ Para empezar:"
	@echo "   SCADA:     make install && make start"
	@echo "   Security:  cd scapy && make setup-security && make detector-start"

# Configuraciones especiales
.ONESHELL:
.SHELLFLAGS := -e -c

# Verificar que el entorno virtual existe para comandos SCADA que lo necesitan
$(PYTHON_VENV):
	@echo "âŒ Error: Entorno virtual no encontrado"
	@echo "ğŸ’¡ Ejecuta: make install"
	@exit 1